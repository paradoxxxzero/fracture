const shifts = {
  0: BigInt(1),
  1: BigInt(10),
  2: BigInt(100),
  3: BigInt(1000),
  4: BigInt(10000),
  5: BigInt(100000),
  6: BigInt(1000000),
  7: BigInt(10000000),
  8: BigInt(100000000),
  9: BigInt(1000000000),
  10: BigInt(10000000000),
}
const shift = precision => {
  if (!shifts[precision]) {
    shifts[precision] = BigInt(10) ** BigInt(precision)
  }
  return shifts[precision]
}
const floatPrecision = 16
const approx = 16

export const consts = {
  PI: "3.1415926535897932384626433832795028841971693993751058209749445923078164062862089986280348253421170679821480865132823066470938446095505822317253594081284811174502841027019385211055596446229489549303819644288109756659334461284756482337867831652712019091456485669234603486104543266482133936072602491412737245870066063155881748815209209628292540917153643678925903600113305305488204665213841469519415116094330572703657595919530921861173819326117931051185480744623799627495673518857527248912279381830119491298336733624406566430860213949463952247371907021798609437027705392171762931767523846748184676694051320005681271452635608277857713427577896091736371787214684409012249534301465495853710507922796892589235420199561121290219608640344181598136297747713099605187072113499999983729780499510597317328160963185950244594553469083026425223082533446850352619311881710100031378387528865875332083814206171776691473035982534904287554687311595628638823537875937519577818577805321712268066130019278766111959092164201989",
  TAU: "6.2831853071795864769252867665590057683943387987502116419498891846156328125724179972560696506842341359642961730265646132941876892191011644634507188162569622349005682054038770422111192892458979098607639288576219513318668922569512964675735663305424038182912971338469206972209086532964267872145204982825474491740132126311763497630418419256585081834307287357851807200226610610976409330427682939038830232188661145407315191839061843722347638652235862102370961489247599254991347037715054497824558763660238982596673467248813132861720427898927904494743814043597218874055410784343525863535047693496369353388102640011362542905271216555715426855155792183472743574429368818024499068602930991707421015845593785178470840399122242580439217280688363196272595495426199210374144226999999967459560999021194634656321926371900489189106938166052850446165066893700705238623763420200062756775057731750664167628412343553382946071965069808575109374623191257277647075751875039155637155610643424536132260038557532223918184328403978",
  ETA: "1.5707963267948966192313216916397514420985846996875529104874722961539082031431044993140174126710585339910740432566411533235469223047752911158626797040642405587251420513509692605527798223114744774651909822144054878329667230642378241168933915826356009545728242834617301743052271633241066968036301245706368622935033031577940874407604604814146270458576821839462951800056652652744102332606920734759707558047165286351828797959765460930586909663058965525592740372311899813747836759428763624456139690915059745649168366812203283215430106974731976123685953510899304718513852696085881465883761923374092338347025660002840635726317804138928856713788948045868185893607342204506124767150732747926855253961398446294617710099780560645109804320172090799068148873856549802593536056749999991864890249755298658664080481592975122297276734541513212611541266723425176309655940855050015689193764432937666041907103085888345736517991267452143777343655797814319411768937968759788909288902660856134033065009639383055979546082100994",
  PHI: "1.6180339887498948482045868343656381177203091798057628621354486227052604628189024497072072041893911374847540880753868917521266338622235369317931800607667263544333890865959395829056383226613199282902678806752087668925017116962070322210432162695486262963136144381497587012203408058879544547492461856953648644492410443207713449470495658467885098743394422125448770664780915884607499887124007652170575179788341662562494075890697040002812104276217711177780531531714101170466659914669798731761356006708748071013179523689427521948435305678300228785699782977834784587822891109762500302696156170025046433824377648610283831268330372429267526311653392473167111211588186385133162038400522216579128667529465490681131715993432359734949850904094762132229810172610705961164562990981629055520852479035240602017279974717534277759277862561943208275051312181562855122248093947123414517022373580577278616008688382952304592647878017889921990270776903895321968198615143780314997411069260886742962267575605231727775203536139362",
  GAMMA: "0.57721566490153286060651209008240243104215933593992359880576723488486772677766467093694706329174674951463144724980708248096050401448654283622417399764492353625350033374293733773767394279259525824709491600873520394816567085323315177661152862119950150798479374508570574002992135478614669402960432542151905877553526733139925401296742051375413954911168510280798423487758720503843109399736137255306088933126760017247953783675927135157722610273492913940798430103417771778088154957066107501016191663340152278935867965497252036212879226555953669628176388792726801324310104765059637039473949576389065729679296010090151251959509222435014093498712282479497471956469763185066761290638110518241974448678363808617494551698927923018773910729457815543160050021828440960537724342032854783670151773943987003023703395183286900015581939880427074115422278197165230110735658339673487176504919418123000406546931429992977795693031005030863034185698032310836916400258929708909854868257773642882539549258736295961332985747393",
  E: "2.718281828459045235360287471352662497757247093699959574966967627724076630353547594571382178525166427427466391932003059921817413596629043572900334295260595630738132328627943490763233829880753195251019011573834187930702154089149934884167509244761460668082264800168477411853742345442437107539077744992069551702761838606261331384583000752044933826560297606737113200709328709127443747047230696977209310141692836819025515108657463772111252389784425056953696770785449969967946864454905987931636889230098793127736178215424999229576351482208269895193668033182528869398496465105820939239829488793320362509443117301238197068416140397019837679320683282376464804295311802328782509819455815301756717361332069811250996181881593041690351598888519345807273866738589422879228499892086805825749279610484198444363463244968487560233624827041978623209002160990235304369941849146314093431738143640546253152096183690888707016768396424378140592714563549061303107208510383750510115747704171898610687396965521267154688957035035402",
  SQRT2: "1.41421356237309504880168872420969807856967187537694807317667973799073247846210703885038753432764157273501384623091229702492483605585073721264412149709993583141322266592750559275579995050115278206057147010955997160597027453459686201472851741864088919860955232923048430871432145083976260362799525140798968725339654633180882964062061525835239505474575028775996172983557522033753185701135437460340849884716038689997069900481503054402779031645424782306849293691862158057846311159666871301301561856898723723528850926486124949771542183342042856860601468247207714358548741556570696776537202264854470158588016207584749226572260020855844665214583988939443709265918003113882464681570826301005948587040031864803421948972782906410450726368813137398552561173220402450912277002269411275736272804957381089675040183698683684507257993647290607629969413804756548237289971803268024744206292691248590521810044598421505911202494413417285314781058036033710773091828693147101711116839165817268894197587165821521282295184884",
  SQRT3: "1.73205080756887729352744634150587236694280525381038062805580697945193301690880003708114618675724857567562614141540670302996994509499895247881165551209437364852809323190230558206797482010108467492326501531234326690332288665067225466892183797122704713166036786158801904998653737985938946765034750657605075661834812960610094760218719032508314582952395983299778982450828871446383291734722416398458785539766795806381835366611084317378089437831610208830552490167002352071114428869599095636579708716849807289949329648428302078640860398873869753758231731783139599298300783870287705391336956331210370726401924910676823119928837564114142201674275210237299427083105989845947598766428889779614783795839022885485290357603385280806438197234466105968972287286526415382266469842002119548415527844118128653450703519165001668929441548084607127714399976292683462957743836189511012714863874697654598245178855097537901388066496191196222295711055524292372319219773826256163146884203285371668293864961191704973883639549593",
  LN10: "2.302585092994045684017991454684364207601101488628772976033327900967572609677352480235997205089598298341967784042286248633409525465082806756666287369098781689482907208325554680843799894826233198528393505308965377732628846163366222287698219886746543667474404243274365155048934314939391479619404400222105101714174800368808401264708068556774321622835522011480466371565912137345074785694768346361679210180644507064800027750268491674655058685693567342067058113642922455440575892572420824131469568901675894025677631135691929203337658714166023010570308963457207544037084746994016826928280848118428931484852494864487192780967627127577539702766860595249671667418348570442250719796500471495105049221477656763693866297697952211071826454973477266242570942932258279850258550978526538320760672631716430950599508780752371033310119785754733154142180842754386359177811705430982748238504564801909561029929182431823752535770975053956518769751037497088869218020518933950723853920514463419726528728696511086257149219884997",
  LN2: "0.6931471805599453094172321214581765680755001343602552541206800094933936219696947156058633269964186875420014810205706857336855202357581305570326707516350759619307275708283714351903070386238916734711233501153644979552391204751726815749320651555247341395258829504530070953263666426541042391578149520437404303855008019441706416715186447128399681717845469570262716310645461502572074024816377733896385506952606683411372738737229289564935470257626520988596932019650585547647033067936544325476327449512504060694381471046899465062201677204245245296126879465461931651746813926725041038025462596568691441928716082938031727143677826548775664850856740776484514644399404614226031930967354025744460703080960850474866385231381816767514386674766478908814371419854942315199735488037516586127535291661000710535582498794147295092931138971559982056543928717000721808576102523688921324497138932037843935308877482597017155910708823683627589842589185353024363421436706118923678919237231467232172053401649256872747782344535347",
  LEMNISCATE: "2.622057554292119810464839589891119413682754951431623162816821703800790587070414250230295532961429093446135752671783218055608956901393935694701119434775235840422641497164906951936899979932146072383121390810206221897429600856554539772305369549710288888325526487021329012097540833128568511729752229214296692430513968456455539432881415381331735108409226312132476667633414509988603429421479224714487963907872564189521811027252516629964333384660679333635093139808526237739409142626489848034804572541477046175421256342129955863129980224054609012091499139897885645312480971101149665075060542093841723886900040274785389625483030580303946324783219558325522973037191341918983592199914229536672569106861130938134980725552913015093730332611087045814240765781886530766932476940761626721636249549480066760961388122322476925591018705775743614648912879832686662030731373313562107612636379245785801781364105361306093563472025022592312041202668270457723044608378953311357002940577442011806826257962983642671092116",
  GAUSS: "0.83462684167407318628142973279904680899399301349034700244982737010368199270952641186969116035127532412906785035241201008672478900763475039265906052674271256032068599897375152146157410719066771476231124461664405187138396784514028386920045138133589075855302049848005280446931643580936897895689068917412073729109406655817518702547740107467837971652635675333190654545251769296103056005406849466254896421861429472075214865365816107620214603752034877535962085677116829220032535910958989989306983319969697733588373910495908596740291824695687469164857451910672757407861143814276105801843203454261549375461009570891175210684201358033124753921938139023239090952343408874222691843888629942222592633521639478011022099075214906939643083603825771794119487059673964272655835084832169397133695059511623882815154747022864207775775371060188804723248904618525301889597025689818013878804895735929346540394633132158338785532854522493441641765173202349682703374720941476496496460623737943995705190866698254812596246577649",
}

export class Decimal {
  constructor(value = 0, precision) {
    if (typeof value === 'bigint') {
      this._n = value
      this.precision = precision || floatPrecision
      return
    }

    if (typeof value === 'number') {
      if (value === 0) {
        value = '0.0'
      } else {
        value = value.toFixed(-Math.log10(Math.abs(value)) + floatPrecision)
      }
    }
    if (typeof value === 'string') {
      if(value.match(/\d+.?e-?\d+/)) {
        value = parseFloat(value).toFixed(floatPrecision)
      }
      if (value in consts) {
        value = consts[value]
      }
    }


    let [ints, decis] = value.split('.').concat('')
    this.precision = precision || decis.length || 1
    this._n = BigInt(
      ints + decis.padEnd(this.precision, '0').slice(0, this.precision)
    )
  }
  toPrecision(precision) {
    if (precision === this.precision) {
      return
    }
    if (precision > this.precision) {
      this._n *= BigInt(10) ** BigInt(precision - this.precision)
    } else {
      this._n /= BigInt(10) ** BigInt(this.precision - precision)
    }
    this.precision = precision
  }
  adapt(num) {
    num = m(num)
    if (this.precision > num.precision) {
      num.toPrecision(this.precision)
    } else if (this.precision < num.precision) {
      this.toPrecision(num.precision)
    }
    return num
  }
  add(num) {
    if (num instanceof Complex) {
      return num.add(this)
    }
    num = this.adapt(num)
    return m(this._n + num._n, this.precision)
  }
  subtract(num) {
    if (num instanceof Complex) {
      return num.neg().add(this)
    }
    num = this.adapt(num)
    return m(this._n - num._n, this.precision)
  }
  multiply(num) {
    if (num instanceof Complex) {
      return num.multiply(this)
    }
    num = this.adapt(num)
    return m((this._n * num._n) / shift(this.precision), this.precision)
  }
  divide(num) {
    if (num instanceof Complex) {
      return num.pow(-1).multiply(this)
    }
    num = this.adapt(num)
    return m((this._n * shift(this.precision)) / num._n, this.precision)
  }
  pow(num) {
    if (num instanceof Complex) {
      return num.pow(this)
    }
    let res = this
    if (num % 1 === 0) {
      for (let i = 1; i < num; i++) {
        res = res.multiply(this)
      }
      return res
    }
    num = this.adapt(num)
    return res.log().multiply(num).exp()
  }
  tetra(num) {
    let res = m(1)
    for (let i = 0; i < num; i++) {
      res = this.pow(res)
    }
    return res
  }
  abs() {
    return m(this._n < 0 ? -this._n : this._n, this.precision)
  }
  sign() {
    return m(this._n < 0 ? -1 : this._n > 0 ? 1 : 0)
  }
  neg() {
    this._n = -this._n
    return this
  }
  nop() {
    return this
  }
  sqrt() {
    const precision = this.precision
    let n = this._n
    let x = n
    let y = (n + 1n) / 2n
    while (y < x) {
      x = y
      y = (x + n / x) / 2n
    }
    return m(x, precision)
  }
  atan() {
    const precision = this.precision
    let x = this
    let y = m(0, precision)
    for (let i = 1; i < approx; i += 2) {
      y = y.add(x.pow(i).divide(i))
      x = x.neg()
    }
    return y
  }
  exp() {
    // Full precision exp
    const precision = this.precision
    let x = this
    let y = m(1, precision)
    for (let i = 1; i < approx; i++) {
      y = y.add(x.pow(i).divide(i))
    }
    return y
  }
  frexp() {
    let x = this
    let e = m()
    while (x.gt(m(1))) {
      x = x.divide(2)
      e = e.add(1)
    }
    return [x, e]
  }
  log() {
    // Compute approximation of log(x)
    // Decompose x = 2^e * p
    // log(x) = e * log(2) + log(p)
    const precision = this.precision
    const [p, e] = this.frexp()
    // Compute log(p) using Taylor series
    let x = p.subtract(1)
    let y = m()
    let sign = 1
    for (let i = 1; i < precision; i++) {
      y = y.add(x.pow(i).divide(i).multiply(sign))
      sign *= -1
    }
    return y.add(e.multiply(LN2(precision)))
  }
  cos() {
    // Full precision cos
    const precision = this.precision
    let x = this
    let y = m(1, precision)
    let sign = -1
    for (let i = 2; i < approx; i += 2) {
      y = y.add(x.pow(i).divide(i).neg().multiply(sign))
      sign *= -1
    }
    return y
  }
  sin() {
    // Full precision sin
    let x = this
    let y = x
    let sign = -1
    for (let i = 3; i < approx; i += 2) {
      y = y.add(x.pow(i).divide(i).neg().multiply(sign))
      sign *= -1
    }
    return y
  }
  tan() {
    // Full precision tan
    const precision = this.precision
    let x = this
    let y = x
    let sign = 1
    for (let i = 3; i < approx; i += 2) {
      y = y.add(x.pow(i).divide(i).multiply(sign))
      sign *= -1
    }
    return y
  }
  sinh() {
    // Full precision sinh
    const precision = this.precision
    let x = this
    let y = m(1, precision)
    for (let i = 2; i < approx; i += 2) {
      y = y.add(x.pow(i).divide(i))
    }
    return y
  }
  cosh() {
    // Full precision cosh
    const precision = this.precision
    let x = this
    let y = m(1, precision)
    for (let i = 2; i < approx; i += 2) {
      y = y.add(x.pow(i).divide(i))
    }
    return y
  }
  acos() {
    // Full precision acos
    const precision = this.precision
    let x = this
    let y = m(0, precision)
    let sign = 1
    for (let i = 1; i < approx; i += 2) {
      y = y.add(x.pow(i).divide(i).multiply(sign))
      sign *= -1
    }
    return y
  }
  asin() {
    // Full precision asin
    const precision = this.precision
    let x = this
    let y = m(0, precision)
    let sign = 1
    for (let i = 1; i < approx; i += 2) {
      y = y.add(x.pow(i).divide(i).multiply(sign))
      sign *= -1
    }
    return y
  }
  toExp() {}
  eq(num) {
    num = this.adapt(num)
    return this._n === num._n
  }
  gt(num) {
    num = this.adapt(num)
    return this._n > num._n
  }
  lt(num) {
    num = this.adapt(num)
    return this._n < num._n
  }
  gte(num) {
    num = this.adapt(num)
    return this._n >= num._n
  }
  lte(num) {
    num = this.adapt(num)
    return this._n <= num._n
  }
  toNumber() {
    return Number(this._n) / Number(shift(this.precision))
  }
  toString() {
    let s = this._n
      .toString()
      .replace('-', '')
      .padStart(this.precision + 1, '0')
    s = (s.slice(0, -this.precision) + '.' + s.slice(-this.precision)).replace(
      /(\.0*|0+)$/,
      ''
    )
    return this._n < 0 ? '-' + s : s
  }
  toFloat() {
    return parseFloat(this.toString())
  }
}

export const m = (v, p) => (!p && v instanceof Decimal ? v : new Decimal(v, p))

export class Complex {
  constructor(re, im) {
    this.re = re
    this.im = im
  }
  add(c) {
    c = cx(c)
    return new Complex(this.re.add(c.re), this.im.add(c.im))
  }
  subtract(c) {
    c = cx(c)
    return new Complex(this.re.subtract(c.re), this.im.subtract(c.im))
  }
  multiply(c) {
    c = cx(c)
    return new Complex(
      this.re.multiply(c.re).subtract(this.im.multiply(c.im)),
      this.re.multiply(c.im).add(this.im.multiply(c.re))
    )
  }
  divide(c) {
    c = cx(c)
    const d = c.re.multiply(c.re).add(c.im.multiply(c.im))
    return new Complex(
      this.re.multiply(c.re).add(this.im.multiply(c.im)).divide(d),
      this.im.multiply(c.re).subtract(this.re.multiply(c.im)).divide(d)
    )
  }
  neg() {
    return new Complex(this.re.neg(), this.im.neg())
  }
  exp() {
    const r = this.re.exp()
    return new Complex(this.im.cos().multiply(r), this.im.sin().multiply(r))
  }
  atan2() {
    // Full precision atan2
    const { re, im } = this
    const absRe = re.abs()
    const absIm = im.abs()
    if (absRe._n === 0n && absIm._n === 0n) {
      return m(0)
    }
    if (absRe._n === 0n) {
      if (im > 0n) {
        return m(Math.PI / 2)
      }
      return m(-Math.PI / 2)
    }
    const t = im.divide(re)
    const atan = t.atan()
    if (re._n > 0n) {
      return atan
    }
    if (im._n >= 0n) {
      return atan.add(Math.PI)
    }
    return atan.subtract(Math.PI)
  }
  sqrt() {
    const r = this.abs().sqrt()
    const theta = this.arg().divide(2)
    return new Complex(r.multiply(theta.cos()), r.multiply(theta.sin()))
  }
  cos() {
    return new Complex(
      this.re.cos().multiply(this.im.sinh()),
      this.re.sin().multiply(this.im.cosh())
    )
  }
  sin() {
    return new Complex(
      this.re.sin().multiply(this.im.cosh()),
      this.re.cos().multiply(this.im.sinh())
    )
  }
  tan() {
    return this.sin().divide(this.cos())
  }
  sinh() {
    return new Complex(
      this.re.sinh().multiply(this.im.cos()),
      this.re.cosh().multiply(this.im.sin())
    )
  }
  cosh() {
    return new Complex(
      this.re.cosh().multiply(this.im.cos()),
      this.re.sinh().multiply(this.im.sin())
    )
  }
  tanh() {
    return this.sinh().divide(this.cosh())
  }
  asin() {
    return this.multiply(this)
      .neg()
      .add(1)
      .sqrt()
      .add(this.im)
      .log()
      .neg()
      .multiply(cx(0, 1))
  }
  acos() {
    return this.multiply(this)
      .neg()
      .add(1)
      .sqrt()
      .add(this)
      .log()
      .neg()
      .multiply(cx(0, 1))
  }
  atan() {
    return this.add(cx(0, 1)).log().neg().multiply(cx(0, 0.5))
  }
  asinh() {
    return this.multiply(this).add(1).sqrt().add(this).log()
  }
  acosh() {
    return this.multiply(this).subtract(1).sqrt().add(this).log()
  }
  atanh() {
    return this.add(1).divide(this.neg().add(1)).log().multiply(cx(0.5))
  }
  log() {
    return new Complex(this.abs().log(), this.arg())
  }

  pow(k) {
    k = cx(k)
    if (k.im.toNumber() === 0) {
      const p = k.re.toNumber()
      if (p % 1 === 0) {
        if (p === 0) {
          return cx(1)
        }
        if (p === 1) {
          return this
        }
        if (p === 2) {
          return this.multiply(this)
        }
        if (p === 3) {
          return this.multiply(this).multiply(this)
        }
        if (p === 4) {
          const z2 = this.multiply(this)
          return z2.multiply(z2)
        }
        if (p === 5) {
          const z2 = this.multiply(this)
          return z2.multiply(z2).multiply(this)
        }
        if (p === 6) {
          const z2 = this.multiply(this)
          return z2.multiply(z2).multiply(z2)
        }
        if (p === 7) {
          const z2 = this.multiply(this)
          return z2.multiply(z2).multiply(z2).multiply(this)
        }
        if (p === 8) {
          const z2 = this.multiply(this)
          const z4 = z2.multiply(z2)
          return z4.multiply(z4)
        }
        if (p === 9) {
          const z2 = this.multiply(this)
          const z4 = z2.multiply(z2)
          return z4.multiply(z4).multiply(this)
        }
        let res = this
        for (let i = 1; i < p; i++) {
          res = res.multiply(this)
        }
        return res
      }
    }
    if (this.re.toNumber() === 0 && this.im.toNumber() === 0) {
      return cx(0)
    }
    if (k.re.toNumber() === 0 && k.im.toNumber() === 0) {
      return cx(1)
    }
    return this.log().multiply(k).exp()
  }
  tetra(num) {
    let res = cx(1)
    for (let i = 0; i < num; i++) {
      res = this.pow(res)
    }
    return res
  }
  norm2() {
    return this.re.multiply(this.re).add(this.im.multiply(this.im))
  }
  norm() {
    return m(this.norm2().sqrt())
  }
  arg() {
    return this.atan2()
  }
  conj() {
    return cx(this.re, -this.im)
  }
  real() {
    return this.re
  }
  imag() {
    return this.im
  }
  toString() {
    return `complex: <${this.re}+${this.im}i>`
  }
  to2fv() {
    return [this.re.toNumber(), this.im.toNumber()]
  }
  static isComplexString(s) {
    return s.match(/^complex: <.+\+.+i>$/)
  }
  static fromString(s) {
    const match = s.match(/^complex: <(.+)\+(.+)i>$/)
    if (!match) {
      throw new Error('Invalid complex string')
    }

    const [, re, im] = match
    return new Complex(m(re), m(im))
  }
}

const LN2 = p =>
  m(
    '0.6931471805599453094172321214581765680755001343602552541206800094933936219696947156058633269964186875420014810205706857336855202357581305570326707516350759619307275708283714351903070386238916734711233501153644979552391204751726815749320651555247341395258829504530070953263666426541042391578149520437404303855008019441706416715186447128399681717845469570262716310645461502572074024816377733896385506952606683411372738737229289564935470257626520988596932019650585547647033067936544325476327449512504060694381471046899465',
    p
  )
export const cx = (re = 0, im = 0, p = null) =>
  re instanceof Complex ? re : new Complex(m(re, p), m(im, p))

window.m = m
window.cx = cx
